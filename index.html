<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultrasonic Thickness Data Entry</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
            color: #333;
        }
        #tableContainer {
            overflow-x: auto;  /* Allows horizontal scrolling */
            background-color: #fff;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            min-width: 600px;  /* Ensures the table is wide enough for sticky positioning to be noticeable */
        }
        th, td {
            border: 1px solid #333;
            padding: 8px;
            text-align: center;
            min-width: 50px;
        }
        th.position-column, td.position-column {
            position: sticky;
            left: 0;
            background-color: white;  /* Ensures that the sticky column has a solid background */
            z-index: 1;
        }
        th {
            position: sticky;
            top: 0;
            background-color: #4CAF50;
            color: white;
            z-index: 2;  /* Ensures that the sticky header is above other content */
        }
        input[type="number"], input[type="text"], input[list], input[type="time"] {
            width: 100%;
            color: #333;
            background-color: #fff;
            border: 1px solid #333;
            padding: 5px;
            box-sizing: border-box;
        }
        input[type="number"]:focus, input[type="text"]:focus, input[list]:focus, input[type="time"]:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px #4CAF50;
        }
        input.filled {
            background-color: #c8e6c9;
        }
        button {
            margin: 10px 5px;
            padding: 10px 15px;
            background-color: #224223;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        button:hover {
            background-color: #258b2a;
        }
        button#clearTable {
            background-color: #f44336;
        }
        button#clearTable:hover {
            background-color: #d32f2f;
        }
        .input-group {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
        }
        .input-group > div {
            flex: 1 1 180px;
            max-width: 220px;
        }
        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #333;
            resize: vertical;
        }
        textarea:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px #4CAF50;
        }
        .results, .saved-data-list {
            margin-top: 20px;
        }
    </style>


</head>
<body>
    <h1>Ultrasonic Thickness Data Entry</h1>
    
    <div class="input-group">
        <div>
            <label for="componentName">Component Name:</label>
            <input type="text" id="componentName" required>
        </div>
        <div>
            <label for="pipeDiameter">Pipe Diameter (inches):</label>
            <input list="pipe-diameters" id="pipeDiameter" required placeholder="Choose diameter...">
            <datalist id="pipe-diameters">
                    <option value="1.050">
                    <option value="1.315">
                    <option value="1.660">
                    <option value="1.900">
                    <option value="1.500">
                    <option value="2.375">
                    <option value="2.875">
                    <option value="3.500">
                    <option value="4.000">
                    <option value="4.500">
                    <option value="5.563">
                    <option value="6.625">
                    <option value="8.625">
                    <option value="10.750">
                    <option value="12.750">
                    <option value="14.000">
                    <option value="16.000">
                    <option value="18.000">
                    <option value="20.000">
                    <option value="22.000">
                    <option value="24.000">
                    <option value="26.000">
                    <option value="28.000">
                    <option value="30.000">
                    <option value="32.000">
                    <option value="34.000">
                    <option value="36.000">
                    <option value="38.000">
                    <option value="40.000">
                    <option value="42.000">
                    <option value="44.000">
                    <option value="46.000">
                    <option value="48.000">
                    <option value="52.000">
                    <option value="54.000">
                    <option value="56.000">
                    <option value="60.000">
                </datalist>
            
        </div>
        <div>
            <label for="wallThickness">Nominal Wall Thickness (mils):</label>
            <input type="number" id="wallThickness" min=100 required>
        </div>
        <div>
            <label for="axialStart">Axial Start (inches):</label>
            <input type="number" id="axialStart" min="0" step="0.1" required>
        </div>
        <div>
            <label for="circumferentialStart">Circumferential Start (hh:mm):</label>
            <input type="text" id="circumferentialStart" required>
        </div>
        <div>
            <label for="length">Length (inches):</label>
            <input type="number" id="length" min="1" required>
        </div>
    </div>

    <button onclick="generateTable()">Generate Table</button>

    <div id="tableContainer"></div>

    <div class="results">
        <p id="minRead">Minimum Reading: N/A</p>
        <p id="avgRead">Average Reading: N/A</p>
    </div>

    <div class="input-group">
        <label for="comments">Comments:</label>
        <textarea id="comments" placeholder="Enter comments here..."></textarea>
    </div>

    <div class="button-group">
        <button onclick="saveData()">Save Data</button>
        <button onclick="loadData()">Load Data</button>
        <button onclick="exportCSV()">Export to CSV</button>
        <button id="clearTable" onclick="clearTable()">Clear Table</button>
    </div>

    <div class="saved-data-list" id="savedDataList">
        <!-- List of saved entries will appear here -->
    </div>

    <script>
let currentComponent = null;

function generateLabel(index) {
    let label = '';
    while (index >= 0) {
        let remainder = index % 26;
        label = String.fromCharCode(65 + remainder) + label;
        index = Math.floor(index / 26) - 1;
    }
    return label;
}

function generateTable() {
    const componentName = document.getElementById('componentName').value;
    const pipeDiameter = parseFloat(document.getElementById('pipeDiameter').value);
    const axialStart = parseFloat(document.getElementById('axialStart').value);
    const circumferentialStart = document.getElementById('circumferentialStart').value;
    const length = parseInt(document.getElementById('length').value);
    const numRows = Math.ceil(Math.PI * pipeDiameter);

    if (!componentName || isNaN(pipeDiameter) || isNaN(axialStart) || !circumferentialStart || isNaN(length)) {
        alert('Please fill in all fields with valid values.');
        return;
    }

    if (!currentComponent) {
        currentComponent = {
            name: componentName,
            pipeDiameter: pipeDiameter,
            axialStart: axialStart,
            circumferentialStart: circumferentialStart,
            length: length,
            data: new Map()
        };
    }

    let table = '<table><tr><th class="position-column">Position</th>';
    for (let i = 1; i <= length; i++) {
        table += `<th>${i}</th>`;
    }
    table += '</tr>';

    for (let i = 0; i < numRows; i++) {
        let rowLabel = generateLabel(i);
        table += `<tr><td class="position-column">${rowLabel}</td>`;
        for (let j = 1; j <= length; j++) {
            table += `<td><input type='number' step='1' min='0' required inputmode='numeric' placeholder='-' data-label='${rowLabel}' data-number='${j}' onchange='updateData("${rowLabel}", ${j}, this.value)'></td>`;
        }
        table += '</tr>';
    }
    table += '</table>';

    document.getElementById('tableContainer').innerHTML = table;
}

function updateData(label, number, value) {
    if (!currentComponent.data.has(label)) {
        currentComponent.data.set(label, {});
    }
    let rowData = currentComponent.data.get(label);
    const inputValue = parseFloat(value) / 1000;  // Divide by 1000 to convert to decimal
    if (isNaN(inputValue) && value !== "") {
        alert("Please enter a valid number.");
        return;
    }

    if (value === "") {
        delete rowData[number];
    } else {
        rowData[number] = inputValue;  // Store data as decimal
        // Check if the input value is outside the nominal wall thickness by more than 20%
        const nominalThickness = parseFloat(document.getElementById('wallThickness').value) / 1000;
        if (Math.abs(inputValue - nominalThickness) > 0.2 * nominalThickness) {
            alert(`Warning: Measurement at ${label}${number} is outside the nominal wall thickness range by more than 20%. Nominal: ${nominalThickness}, Measured: ${inputValue}`);
        }
    }
    currentComponent.data.set(label, rowData);
    updateResults();
}

function exportCSV() {
    if (!currentComponent || currentComponent.data.size === 0) {
        alert('Please generate and fill in the table before exporting.');
        return;
    }
    const comments = document.getElementById('comments').value;
    let csvContent = [];
    csvContent.push(`Component Name: ${currentComponent.name}`);
    csvContent.push(`Pipe Diameter: ${currentComponent.pipeDiameter} inches`);
    csvContent.push(`Axial Start: ${currentComponent.axialStart} inches`);
    csvContent.push(`Circumferential Start: ${currentComponent.circumferentialStart}`);
    const nominalThickness = parseFloat(document.getElementById('wallThickness').value) / 1000;
    csvContent.push(`Nominal Wall Thickness: ${nominalThickness.toFixed(3)} inches`);  // Converted to decimal
    csvContent.push(`Comments: ${comments}\n`);

    let header = ['Position'];
    for (let i = 1; i <= currentComponent.length; i++) {
        header.push(i);
    }
    csvContent.push(header.join(','));

    for (let [label, rowData] of currentComponent.data.entries()) {
        let row = [label];
        for (let i = 1; i <= currentComponent.length; i++) {
            row.push(rowData[i] ? rowData[i].toFixed(3) : '');
        }
        csvContent.push(row.join(','));
    }

    const allValues = Array.from(currentComponent.data.values()).flatMap(row => Object.values(row));
    const minRead = allValues.length ? Math.min(...allValues) : 'N/A';
    const avgRead = allValues.length ? (allValues.reduce((sum, val) => sum + val, 0) / allValues.length).toFixed(3) : 'N/A';

    csvContent.push(`\nMinimum Reading: ${minRead}`);
    csvContent.push(`Average Reading: ${avgRead}`);

    const blob = new Blob([csvContent.join('\r\n')], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.setAttribute('href', url);
    link.setAttribute('download', `${currentComponent.name}_thickness_data.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}


    </script>
</body>
</html>
