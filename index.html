<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultrasonic Thickness Data Entry</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
            color: #333;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            background-color: #fff;
        }
        th, td {
            border: 1px solid #333;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
        }
        input[type="number"], input[type="text"], input[list], input[type="time"] {
            width: 100%;
            color: #333;
            background-color: #fff;
            border: 1px solid #333;
            padding: 5px;
            box-sizing: border-box;
        }
        input[type="number"]:focus, input[type="text"]:focus, input[list]:focus, input[type="time"]:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px #4CAF50;
        }
        input.filled {
            background-color: #c8e6c9; /* Light green background for filled inputs */
        }
        button {
            margin: 10px 5px;
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        button:hover {
            background-color: #45a049;
        }
        button#clearTable {
            background-color: #f44336;
        }
        button#clearTable:hover {
            background-color: #d32f2f;
        }
        .input-group {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
        }
        .input-group > div {
            flex: 1 1 180px;
            max-width: 220px;
        }
        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #333;
            resize: vertical;
        }
        textarea:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px #4CAF50;
        }
        .results, .saved-data-list {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Ultrasonic Thickness Data Entry</h1>
    
    <div class="input-group">
        <div>
            <label for="componentName">Component Name:</label>
            <input type="text" id="componentName" required>
        </div>
        <div>
            <label for="pipeDiameter">Pipe Diameter (inches):</label>
            <input list="pipe-diameters" id="pipeDiameter" required placeholder="Choose diameter...">
            <datalist id="pipe-diameters">
                    <option value="1.050">
                    <option value="1.315">
                    <option value="1.660">
                    <option value="1.900">
                    <option value="1.500">
                    <option value="2.375">
                    <option value="2.875">
                    <option value="3.500">
                    <option value="4.000">
                    <option value="4.500">
                    <option value="5.563">
                    <option value="6.625">
                    <option value="8.625">
                    <option value="10.750">
                    <option value="12.750">
                    <option value="14.000">
                    <option value="16.000">
                    <option value="18.000">
                    <option value="20.000">
                    <option value="22.000">
                    <option value="24.000">
                    <option value="26.000">
                    <option value="28.000">
                    <option value="30.000">
                    <option value="32.000">
                    <option value="34.000">
                    <option value="36.000">
                    <option value="38.000">
                    <option value="40.000">
                    <option value="42.000">
                    <option value="44.000">
                    <option value="46.000">
                    <option value="48.000">
                    <option value="52.000">
                    <option value="54.000">
                    <option value="56.000">
                    <option value="60.000">
                </datalist>
        </div>
        <div>
            <label for="axialStart">Axial Start (inches):</label>
            <input type="number" id="axialStart" min="0" step="0.1" inputmode="decimal" required>
        </div>
        <div>
            <label for="circumferentialStart">Circumferential Start (hh:mm):</label>
            <input type="text" id="circumferentialStart" required>
        </div>
        <div>
            <label for="length">Length (inches):</label>
            <input type="number" id="length" min="1" required inputmode="numeric">
        </div>
    </div>

    <button onclick="generateTable()">Generate Table</button>

    <div id="tableContainer"></div>

    <div class="results">
        <p id="minRead">Minimum Reading: N/A</p>
        <p id="avgRead">Average Reading: N/A</p>
    </div>

    <div class="input-group">
        <label for="comments">Comments:</label>
        <textarea id="comments" placeholder="Enter comments here..."></textarea>
    </div>

    <div class="button-group">
        <button onclick="saveData()">Save Data</button>
        <button onclick="loadData()">Load Data</button>
        <button onclick="exportCSV()">Export to CSV</button>
        <button id="clearTable" onclick="clearTable()">Clear Table</button>
    </div>

    <div class="saved-data-list" id="savedDataList">
        <!-- List of saved entries will appear here -->
    </div>

    <script>
        let currentComponent = null;

        document.addEventListener('DOMContentLoaded', function() {
            updateSavedList();
        });

        function generateLabel(index) {
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let label = '';
            
            if (index < 26) {
                label = alphabet[index];
            } else {
                let prefix = Math.floor(index / 26) - 1;
                let suffix = index % 26;
                label = alphabet[prefix] + alphabet[suffix];
            }
            
            return label;
        }
        
        function generateTable() {
            const componentName = document.getElementById('componentName').value;
            const pipeDiameter = parseFloat(document.getElementById('pipeDiameter').value);
            const axialStart = parseFloat(document.getElementById('axialStart').value);
            const circumferentialStart = document.getElementById('circumferentialStart').value;
            const length = parseInt(document.getElementById('length').value);
            
            if (!componentName || isNaN(pipeDiameter) || isNaN(axialStart) || !circumferentialStart || isNaN(length)) {
                alert('Please fill in all fields with valid values.');
                return;
            }
            
            const circumference = Math.PI * pipeDiameter;
            const numCircumFields = Math.ceil(circumference);
            
            currentComponent = {
                name: componentName,
                pipeDiameter: pipeDiameter,
                axialStart: axialStart,
                circumferentialStart: circumferentialStart,
                circumference: circumference,
                numCircumFields: numCircumFields,
                length: length,
                data: {}
            };
            
            let table = '<table><tr><th>Position</th>';
            for (let i = 1; i <= length; i++) {
                table += `<th>${i}</th>`;
            }
            table += '</tr>';
            
            for (let i = 0; i < numCircumFields; i++) {
                const label = generateLabel(i);
                table += `<tr><td>${label}</td>`;
                for (let j = 1; j <= length; j++) {
                    table += `<td><input type='number' step='1' min='0' required inputmode='numeric' placeholder='-' data-label='${label}' data-number='${j}' onchange='updateData("${label}", ${j}, this.value)'></td>`;
                }
                table += '</tr>';
            }
            table += '</table>';
            
            document.getElementById('tableContainer').innerHTML = table;
        }

        function updateData(label, number, value) {
            const cellSelector = `input[data-label='${label}'][data-number='${number}']`;
            const inputElement = document.querySelector(cellSelector);
            if (!currentComponent.data[label]) {
                currentComponent.data[label] = {};
            }
            if (value === "") {
                delete currentComponent.data[label][number];
                inputElement.classList.remove('filled');
                if (Object.keys(currentComponent.data[label]).length === 0) {
                    delete currentComponent.data[label];
                }
            } else {
                currentComponent.data[label][number] = parseFloat(value); // Adjust as necessary
                inputElement.classList.add('filled');
            }
            updateResults();
        }
        
        function updateResults() {
            if (!currentComponent) return;
            let allValues = [];
            Object.values(currentComponent.data).forEach(row => {
                Object.values(row).forEach(value => {
                    if (value !== null && value !== undefined) {
                        allValues.push(value);
                    }
                });
            });
            const minRead = allValues.length ? Math.min(...allValues) : 'N/A';
            const avgRead = allValues.length ? (allValues.reduce((sum, val) => sum + val, 0) / allValues.length) : 'N/A';
            document.getElementById('minRead').textContent = `Minimum Reading: ${minRead.toFixed(3)}`;
            document.getElementById('avgRead').textContent = `Average Reading: ${avgRead.toFixed(3)}`;
        }
        
        function saveData() {
            if (!currentComponent) {
                alert('Please generate a table first.');
                return;
            }
            currentComponent.timestamp = new Date().toLocaleString();
            let savedComponents = JSON.parse(localStorage.getItem('components') || '[]');
            const index = savedComponents.findIndex(comp => comp.name === currentComponent.name);
            if (index !== -1) {
                savedComponents[index] = currentComponent;
            } else {
                savedComponents.push(currentComponent);
            }
            localStorage.setItem('components', JSON.stringify(savedComponents));
            alert('Data saved successfully!');
            updateSavedList();
        }

        function loadData(index) {
            const savedComponents = JSON.parse(localStorage.getItem('components') || '[]');
            const component = savedComponents[index];
            if (component) {
                currentComponent = component;
                document.getElementById('componentName').value = component.name;
                document.getElementById('pipeDiameter').value = component.pipeDiameter;
                document.getElementById('axialStart').value = component.axialStart;
                document.getElementById('circumferentialStart').value = component.circumferentialStart;
                document.getElementById('length').value = component.length;
                generateTable(); // This should populate the inputs with saved data
                alert('Data loaded successfully!');
            } else {
                alert('No saved data found for this component.');
            }
        }

        function updateSavedList() {
            const savedComponents = JSON.parse(localStorage.getItem('components') || '[]');
            const listContainer = document.getElementById('savedDataList');
            listContainer.innerHTML = '';
            savedComponents.forEach((component, index) => {
                const link = document.createElement('a');
                link.textContent = `${component.name} - ${component.timestamp}`;
                link.href = '#';
                link.onclick = () => loadData(index);
                listContainer.appendChild(link);
                listContainer.appendChild(document.createElement('br'));
            });
        }

        function exportCSV() {
            if (!currentComponent) {
                alert('Please generate a table first.');
                return;
            }
            const comments = document.getElementById('comments').value;
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += `Component Name: ${currentComponent.name}\r\n`;
            csvContent += `Pipe Diameter: ${currentComponent.pipeDiameter} inches\r\n`;
            csvContent += `Axial Start: ${currentComponent.axialStart} inches\r\n`;
            csvContent += `Circumferential Start: ${currentComponent.circumferentialStart}\r\n`;
            csvContent += `Calculated Circumference: ${currentComponent.circumference.toFixed(2)} inches\r\n`;
            csvContent += `Length: ${currentComponent.length} inches\r\n`;
            csvContent += `Comments: ${comments}\r\n\r\n`;

            csvContent += 'Position,';
            for (let i = 1; i <= currentComponent.length; i++) {
                csvContent += `${i},`;
            }
            csvContent = csvContent.slice(0, -1) + '\r\n';

            for (let i = 0; i < currentComponent.numCircumFields; i++) {
                const label = generateLabel(i);
                csvContent += `${label},`;
                for (let j = 1; j <= currentComponent.length; j++) {
                    csvContent += `${currentComponent.data[label] && currentComponent.data[label][j] ? currentComponent.data[label][j].toFixed(3) : ''},`;
                }
                csvContent = csvContent.slice(0, -1) + '\r\n';
            }

            const allValues = Object.values(currentComponent.data).flatMap(row => Object.values(row));
            const minRead = allValues.length ? Math.min(...allValues) : 'N/A';
            const avgRead = allValues.length ? (allValues.reduce((sum, val) => sum + val, 0) / allValues.length).toFixed(3) : 'N/A';

            csvContent += `\nMinimum Reading: ${minRead}\n`;
            csvContent += `Average Reading: ${avgRead}\n`;

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `${currentComponent.name}_thickness_data.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function clearTable() {
            if (confirm("Are you sure you want to clear the table? All unsaved data will be lost.")) {
                currentComponent = null;
                document.getElementById('tableContainer').innerHTML = '';
                document.getElementById('componentName').value = '';
                document.getElementById('pipeDiameter').value = '';
                document.getElementById('axialStart').value = '';
                document.getElementById('circumferentialStart').value = '';
                document.getElementById('length').value = '';
                document.getElementById('comments').value = '';
                document.getElementById('minRead').innerText = 'Minimum Reading: N/A';
                document.getElementById('avgRead').innerText = 'Average Reading: N/A';
            }
        }
    </script>
</body>
</html>
